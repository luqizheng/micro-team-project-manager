# 项目管理工具重构 - 对齐阶段

## 项目上下文分析

### 现有项目架构
- **技术栈**: Vue3 + Ant Design + NestJS + TypeORM + MySQL 8
- **架构模式**: 前后端分离，RESTful API + Webhook，事件驱动
- **现有集成**: 已有GitLab集成功能，支持双向同步
- **权限系统**: 基于RBAC的三角色系统（Viewer/Member/Project Admin/System Admin）

### 当前数据模型分析
基于代码分析，当前系统使用统一的`IssueEntity`来管理所有工作项：

#### 现有Issue类型（IssueType枚举）
```typescript
export enum IssueType {
  requirement = 'requirement',  // 需求
  task = 'task',               // 任务  
  bug = 'bug',                 // 缺陷
}
```

#### 现有Issue实体结构
- 使用单一表结构存储所有类型的工作项
- 通过`type`字段区分不同类型
- 支持父子关系（`parentId`字段）
- 包含完整的项目管理字段（状态、优先级、工时等）

### 现有GitLab集成分析
- **映射关系**: PM项目 ↔ GitLab Group
- **同步机制**: 双向同步，支持Issue级别的同步
- **数据表**: 包含GitLab实例、项目映射、用户映射、事件日志等表

## 需求理解确认

### 原始需求
根据需求规格说明2.0，需要重构PM系统以支持新的层级结构：

#### 新的工作项类型
1. **需求（Requirement）**：业务或技术需求，可分解为功能模块或任务
2. **子系统（Subsystem）**：系统的子部分，包含多个功能模块
3. **功能模块（Feature Module）**：独立的功能组件，包含多个相关任务
4. **任务（Task）**：具体的工作单元，可分配给个人完成
5. **缺陷（Bug）**：系统中发现的问题或错误

#### 层级关系
- 需求 → 子系统 → 功能模块 → 任务/缺陷
- 任务属于需求/功能模块/子系统下的子项
- 缺陷属于功能模块/子系统下的子项

#### GitLab集成映射
- PM项目 → GitLab Group
- 需求/功能模块/子系统 → GitLab Epic
- 任务/缺陷 → GitLab Issue

### 核心特性
1. **层级结构管理**
   - 支持需求-子系统-功能模块-任务/缺陷的层级结构
   - 支持层级间的依赖关系跟踪
   - 支持跨层级的状态汇总和进度统计

2. **GitLab集成增强**
   - 支持Epic级别的同步（需求/功能模块/子系统）
   - 保持Issue级别的同步（任务/缺陷）
   - 维护层级关系在GitLab中的映射

3. **数据模型重构**
   - 从单一Issue表重构为多个独立实体
   - 保持数据完整性和迁移兼容性
   - 支持现有GitLab集成的平滑升级

## 需求理解

### 对现有项目的理解
1. **数据模型复杂性**：当前使用单一Issue表，需要拆分为多个独立实体
2. **GitLab集成深度**：现有集成需要扩展支持Epic级别同步
3. **前端组件影响**：大量组件依赖现有Issue结构，需要渐进式重构
4. **API兼容性**：需要保持API向后兼容，避免破坏现有功能

### 技术约束
- 必须与现有NestJS架构兼容
- 必须使用现有的TypeORM实体系统
- 必须保持现有GitLab集成功能
- 必须支持数据迁移而不丢失现有数据
- 必须保持API向后兼容性

## 疑问澄清

### 关键决策点

1. **数据模型重构策略**
   - 是否采用渐进式重构（保持现有Issue表，新增独立实体）？不需要
   - 还是采用完全重构（直接替换为新的实体结构）？重新生成，没用的可以直接删除
   - 如何处理现有数据的迁移？不需要

2. **GitLab集成扩展**
   - 如何实现Epic级别的同步？同步的时候，输入时goroupid，通过groupId进行同步。后继再塔伦
   - 如何处理层级关系在GitLab中的映射？通过父项进行。
   - 是否需要新增GitLab Epic相关的数据表？需要。

3. **API设计策略**
   - 是否需要保持现有Issue API的兼容性？不需要兼容
   - 如何设计新的层级结构API？parent_id 进行。
   - 如何处理前端组件的渐进式迁移？不需要。可以重新编写。

4. **前端重构策略**
   - 是否需要同时重构所有前端组件？重构
   - 如何设计新的层级结构UI？后面再讨论
   - 如何处理现有Issue相关功能的迁移？不需要管理迁移问题，删除就可以

5. **数据迁移策略**
   - 如何将现有Issue数据迁移到新的实体结构？删除。重新创建
   - 如何处理父子关系的重新映射？重新创建。
   - 如何保证迁移过程的数据完整性？不需要保证。

### 需要确认的技术细节

1. **实体关系设计**：新实体的具体字段设计和关系定义
2. **API版本策略**：是否使用API版本控制来支持渐进式迁移
3. **数据库迁移**：具体的迁移脚本和策略
4. **前端组件架构**：新组件与现有组件的集成方式
5. **GitLab API扩展**：Epic相关API的集成方式

## 下一步行动

需要用户确认以上关键决策点，特别是：
1. 数据模型重构策略的选择（渐进式 vs 完全重构）
2. GitLab集成扩展的具体实现方式
3. API兼容性策略的选择
4. 前端重构的优先级和策略
5. 数据迁移的具体方案

确认后进入CONSENSUS阶段。
