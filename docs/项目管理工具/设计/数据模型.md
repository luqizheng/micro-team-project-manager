## 数据模型与实体关系（草案）

### 1. 关键实体
- 组织 Organization（多租户可选）
- 用户 User / 认证 Credential
- 项目 Project、成员 Membership（角色关系）
- 事项 Issue（抽象父类）：需求 Requirement、任务 Task、缺陷 Bug
- 看板 Board、列 Column、WIP 规则 WipRule
- 迭代 Sprint、版本 Release
- 评论 Comment、附件 Attachment、标签 Label、订阅 Subscription
- 通知 Notification、Webhook、自动化规则 Rule

### 2. 核心表（建议字段，非最终）
- `users`：id, email, name, status, avatar, created_at, updated_at
- `projects`：id, org_id, key, name, visibility, created_by, created_at, updated_at, archived
- `memberships`：id, project_id, user_id, role, created_at
- `issues`：id, project_id, type, title, description, state, priority, severity, assignee_id, reporter_id, story_points, estimate, remaining, sprint_id, release_id, parent_id, labels, due_at, created_at, updated_at, deleted
- `boards`：id, project_id, name, created_at
- `board_columns`：id, board_id, name, wip_limit, order, state_mapping, created_at
- `comments`：id, issue_id, author_id, body, mentions, created_at, updated_at
- `attachments`：id, issue_id, object_key, file_name, size, content_type, created_at
- `sprints`：id, project_id, name, start_at, end_at, goal, capacity, created_at
- `releases`：id, project_id, name, tag, notes, released_at, created_at
- `notifications`：id, user_id, type, entity_type, entity_id, payload, read_at, created_at
- `webhooks`：id, project_id, url, secret, events, is_active, created_at, updated_at
- `rules`：id, project_id, name, trigger, condition, action, is_active, created_at

### 3. 关系概要
- 用户 1..n 成员，成员 n..1 项目（角色在成员上）。
- 项目 1..n 事项；事项与迭代/版本是可选 n..1 关系；事项可有父子（子任务）。
- 项目 1..n 看板；看板 1..n 列；列与事项状态映射（state_mapping）。
- 事项 1..n 评论与附件；n..n 标签（可用数组/关联表）。
- 用户 n..n 订阅事项；
- 项目 1..n Webhook 与自动化规则。

### 4. 状态与流转
- 任务：Backlog/InProgress/Blocked/InReview/QA/Done；
- 缺陷：New/Triage/Fixing/Verify/Closed/Reopen；
- 利用 `state_transitions` 审计（issue_id, from, to, operator_id, at）。

### 5. 索引建议
- `issues(project_id, state, assignee_id, updated_at desc)` 复合索引；
- `comments(issue_id, created_at)`；
- `sprints(project_id, start_at, end_at)`；
- `releases(project_id, released_at)`；
- 文本字段使用全文索引（title, description, comments.body）。

### 6. 审计与软删
- 所有核心表具备创建/更新者与时间，`deleted` 软删；
- 关键动作写入 `audit_logs`：actor, action, entity, entity_id, payload, at。

### 7. 权限辅助
- `memberships(role)` 决定项目级权限；
- 行级权限通过 `project_id` 过滤；
- 如需更细，增加 `role_policies`/`role_permissions`。

### 8. ER 图（文字版）
```
User --< Membership >-- Project --< Issue >-- Comment
                              | \                     
                              |  \> Attachment        
                              |                       
                              \> Board --< Column     
                               \> Sprint              
                               \> Release             
Issue >-- Subscription --< User
Project --< Webhook
Project --< Rule
```


