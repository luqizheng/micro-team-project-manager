# 管理员角色初始化功能说明

## 功能概述

系统启动时会自动为配置的管理员邮箱创建用户账户，并分配系统管理员角色，确保系统有可用的管理员账户。

## 实现细节

### 1. 数据库结构更新

#### 用户表新增字段
- **systemRoles**: JSON 类型字段，存储用户的系统级角色
- 支持存储多个系统角色，如 `["admin"]`

#### 数据库迁移
- 创建了迁移文件 `1710000007000-AddSystemRolesToUsers.ts`
- 自动添加 `systemRoles` 字段到 `users` 表

### 2. 角色系统架构

#### 角色类型
- **系统角色**：存储在 `users.systemRoles` 字段中
  - `admin`: 全局管理员
  - `project_manager`: 项目经理
  - `member`: 普通成员

- **项目角色**：存储在 `memberships` 表中
  - 用户在特定项目中的角色
  - 与系统角色独立管理

#### 角色合并逻辑
- 登录时合并系统角色和项目角色
- 系统角色具有全局权限
- 项目角色仅在特定项目中有效

### 3. 初始化流程

#### 配置参数
- `ADMIN_EMAILS`: 管理员邮箱列表（逗号分隔）
- `ADMIN_DEFAULT_PASSWORD`: 默认密码（默认：admin123456）

#### 初始化步骤
1. 读取环境变量中的管理员邮箱
2. 为每个邮箱创建用户账户
3. 分配 `admin` 系统角色
4. 设置默认密码
5. 记录初始化日志

### 4. 代码实现

#### 后端实现
```typescript
// app.initializer.ts
async onApplicationBootstrap() {
  const adminsRaw = this.config.get<string>('ADMIN_EMAILS') ?? '';
  const emails = adminsRaw.split(/[\s,;]+/).map(e => e.trim().toLowerCase()).filter(Boolean);
  
  for (const email of emails) {
    const existing = await this.users.findByEmail(email);
    if (existing) continue;
    
    await this.users.createBasic({ 
      email, 
      name: email.split('@')[0], 
      passwordHash: this.hash(defaultPassword), 
      status: 'active',
      systemRoles: ['admin']
    });
  }
}
```

#### 用户服务更新
- 新增 `getUserRoles()` 方法合并系统角色和项目角色
- 更新 `create()` 和 `update()` 方法支持系统角色
- 在用户详情中包含系统角色信息

#### 认证服务更新
- 登录时获取用户的所有角色（系统角色 + 项目角色）
- 返回完整的角色信息给前端

### 5. 前端显示

#### 用户管理页面
- 新增"系统角色"列显示用户的系统级角色
- 使用不同颜色的标签区分角色类型
- 支持查看用户的完整角色信息

#### 角色标签颜色
- `admin`: 红色标签
- `project_admin`: 蓝色标签
- `member`: 绿色标签
- `viewer`: 默认颜色标签

## 使用方法

### 1. 环境配置
```bash
# .env 文件
ADMIN_EMAILS=admin@example.com,manager@example.com
ADMIN_DEFAULT_PASSWORD=your_secure_password
```

### 2. 启动系统
- 系统启动时会自动执行初始化
- 检查日志确认管理员账户创建成功
- 使用配置的邮箱和密码登录

### 3. 验证功能
- 登录后检查用户角色信息
- 确认具有系统管理员权限
- 可以访问用户管理功能

## 安全考虑

### 1. 密码安全
- 使用 SHA256 哈希存储密码
- 建议修改默认密码
- 定期更换管理员密码

### 2. 权限控制
- 只有系统管理员可以管理用户
- 角色权限在多个层面验证
- 防止权限提升攻击

### 3. 初始化安全
- 只在首次启动时创建管理员
- 避免重复创建相同邮箱的用户
- 记录所有初始化操作

## 扩展功能

### 1. 批量角色分配
- 支持为多个用户批量分配角色
- 支持角色模板和预设

### 2. 角色继承
- 支持基于组织的角色继承
- 支持临时角色和过期时间

### 3. 审计日志
- 记录角色变更历史
- 记录管理员操作日志
- 支持角色变更回滚

## 故障排除

### 1. 初始化失败
- 检查环境变量配置
- 检查数据库连接
- 查看应用启动日志

### 2. 角色不生效
- 确认数据库迁移已执行
- 检查用户角色数据
- 重新登录获取最新角色

### 3. 权限问题
- 检查用户角色配置
- 确认路由权限设置
- 验证 JWT 令牌有效性
