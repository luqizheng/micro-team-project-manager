# 三角色系统设计说明

## 概述

根据小型团队的需求，项目管理系统采用简化的三角色设计，提供清晰、易管理的权限控制。

## 角色定义

### 1. 全局管理员（Admin）
- **权限范围**：系统级权限，拥有所有功能的使用权限
- **主要职责**：
  - 用户管理（创建、编辑、删除用户）
  - 系统配置和维护
  - 所有项目的完全访问权限
  - 数据备份和恢复
- **系统角色标识**：`admin`

### 2. 项目经理（Project Manager）
- **权限范围**：项目级管理权限
- **主要职责**：
  - 项目创建和管理
  - 项目成员管理（添加、移除、角色分配）
  - 看板配置和流程设置
  - 迭代和版本管理
  - 项目数据导出
  - 事项管理（创建、编辑、删除、状态流转）
- **系统角色标识**：`project_manager`

### 3. 成员（Member）
- **权限范围**：基础协作权限
- **主要职责**：
  - 查看项目信息
  - 创建和编辑事项
  - 添加评论和附件
  - 看板操作（移动事项、更新状态）
  - 查看报表
  - 订阅通知
- **系统角色标识**：`member`

## 权限矩阵

| 功能模块 | Admin | Project Manager | Member |
|---------|-------|----------------|--------|
| 用户管理 | ✅ | ❌ | ❌ |
| 系统设置 | ✅ | ❌ | ❌ |
| 项目创建 | ✅ | ✅ | ✅ |
| 项目编辑 | ✅ | ✅ | ❌ |
| 项目删除 | ✅ | ✅ | ❌ |
| 成员管理 | ✅ | ✅ | ❌ |
| 事项管理 | ✅ | ✅ | ✅ |
| 看板配置 | ✅ | ✅ | ❌ |
| 迭代管理 | ✅ | ✅ | ❌ |
| 版本管理 | ✅ | ✅ | ❌ |
| 报表查看 | ✅ | ✅ | ✅ |
| 数据导出 | ✅ | ✅ | ❌ |

## 技术实现

### 角色存储
- **系统角色**：存储在 `users.systemRoles` JSON 字段中
- **项目角色**：存储在 `memberships` 表中，用于项目级权限控制

### 权限验证
- 使用 `@Roles()` 装饰器在控制器方法上声明所需角色
- `RolesGuard` 守卫负责验证用户权限
- 支持系统角色和项目角色的组合验证

### 角色继承
- Admin 角色拥有所有权限，无需额外验证
- Project Manager 在项目内拥有 Member 的所有权限
- 权限检查采用"包含"逻辑，即拥有更高权限的角色自动拥有较低权限

## 迁移说明

从原有的四角色系统（admin、project_admin、member、viewer）迁移到三角色系统：

1. **project_admin** → **project_manager**
2. **viewer** → **member**（原有只读权限合并到成员权限中）
3. **admin** 和 **member** 保持不变

## 使用建议

### 小型团队配置
- 建议设置 1-2 个 Admin 用户作为系统管理员
- 每个项目设置 1-2 个 Project Manager
- 其他团队成员设置为 Member

### 权限分配原则
- 遵循最小权限原则，只分配必要的权限
- 定期审查用户角色，确保权限分配合理
- 项目结束后及时移除相关权限

## 扩展性

虽然当前设计为三角色，但系统架构支持未来扩展：
- 可以添加新的系统角色
- 可以增加项目级自定义角色
- 权限矩阵可以灵活调整

这种设计既满足了小型团队的简化需求，又保持了系统的可扩展性。
