# 用户列表加载问题排查

## 问题描述

在UserSelector组件中出现"加载用户列表失败"的错误。

## 问题原因

UserSelector组件尝试访问 `/projects/${projectId}/members` 接口，但后端缺少这个接口。

## 解决方案

### 1. 已添加的接口

#### 后端接口
- **路径**: `GET /projects/:id/members`
- **权限**: `admin`, `project_manager`, `member`
- **参数**: 
  - `page`: 页码 (默认: 1)
  - `pageSize`: 每页数量 (默认: 50)
  - `q`: 搜索关键词 (可选)

#### 数据库关系
- 添加了 `MembershipEntity` 与 `UserEntity` 的关系
- 支持通过项目ID查询项目成员

### 2. 修改的文件

#### 后端文件
1. **`server/src/modules/projects/projects.service.ts`**
   - 添加了 `getProjectMembers` 方法
   - 支持分页和搜索功能

2. **`server/src/modules/projects/projects.controller.ts`**
   - 添加了 `GET /:id/members` 接口
   - 配置了适当的权限控制

3. **`server/src/modules/projects/projects.module.ts`**
   - 导入了 `MembershipEntity` 和 `UserEntity`
   - 配置了TypeORM实体

4. **`server/src/modules/memberships/membership.entity.ts`**
   - 添加了与 `UserEntity` 的关系
   - 支持关联查询

### 3. 前端组件

#### UserSelector组件逻辑
```typescript
// 加载用户列表
const loadUsers = async () => {
  let url = '/users';
  const params = { page: 1, pageSize: 50 };
  
  // 如果有搜索关键词
  if (searchKeyword.value) {
    params.q = searchKeyword.value;
  }
  
  // 如果指定了项目ID，获取项目成员
  if (props.projectId) {
    url = `/projects/${props.projectId}/members`;
  }
  
  const response = await http.get(url, { params });
  // 处理响应...
};
```

## 测试步骤

### 1. 启动后端服务
```bash
cd server
npm run start:dev
```

### 2. 测试API接口
```bash
# 测试用户列表
curl -X GET "http://localhost:3000/users" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 测试项目成员
curl -X GET "http://localhost:3000/projects/PROJECT_ID/members" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 3. 检查数据库
确保数据库中有以下数据：
- 用户数据 (`users` 表)
- 项目数据 (`projects` 表)
- 成员关系数据 (`memberships` 表)

## 常见问题

### 1. 权限问题
**错误**: `ForbiddenException: Insufficient role`
**解决**: 确保用户有适当的角色权限

### 2. 数据库关系问题
**错误**: `Cannot read property 'user' of undefined`
**解决**: 检查 `MembershipEntity` 与 `UserEntity` 的关系配置

### 3. 项目ID不存在
**错误**: `Project not found`
**解决**: 确保传入的项目ID存在且有效

### 4. 网络连接问题
**错误**: `Network Error` 或 `ECONNREFUSED`
**解决**: 检查后端服务是否正常运行

## 调试方法

### 1. 检查网络请求
在浏览器开发者工具中查看Network标签：
- 请求URL是否正确
- 请求头是否包含Authorization
- 响应状态码和错误信息

### 2. 检查后端日志
查看后端控制台输出：
- 是否有错误日志
- 数据库查询是否正常
- 权限验证是否通过

### 3. 检查数据库
```sql
-- 检查用户数据
SELECT * FROM users LIMIT 5;

-- 检查项目数据
SELECT * FROM projects LIMIT 5;

-- 检查成员关系
SELECT m.*, u.name, u.email 
FROM memberships m 
LEFT JOIN users u ON m.user_id = u.id 
LIMIT 5;
```

## 预防措施

### 1. 错误处理
在UserSelector组件中添加更详细的错误处理：
```typescript
catch (error) {
  console.error('加载用户列表失败:', error);
  if (error.response?.status === 403) {
    message.error('权限不足，无法加载用户列表');
  } else if (error.response?.status === 404) {
    message.error('项目不存在');
  } else {
    message.error('加载用户列表失败');
  }
  userList.value = [];
}
```

### 2. 加载状态
显示加载状态，提升用户体验：
```typescript
const loading = ref(false);

// 在loadUsers方法中
loading.value = true;
try {
  // 加载逻辑
} finally {
  loading.value = false;
}
```

### 3. 重试机制
添加重试功能：
```typescript
const retryCount = ref(0);
const maxRetries = 3;

const loadUsers = async () => {
  try {
    // 加载逻辑
  } catch (error) {
    if (retryCount.value < maxRetries) {
      retryCount.value++;
      setTimeout(() => loadUsers(), 1000);
    } else {
      // 显示错误
    }
  }
};
```

## 总结

通过添加项目成员接口和配置数据库关系，解决了UserSelector组件"加载用户列表失败"的问题。现在组件可以：

1. 加载所有用户（当没有指定项目ID时）
2. 加载项目成员（当指定了项目ID时）
3. 支持搜索功能
4. 提供适当的错误处理

确保后端服务正常运行，数据库连接正常，用户有适当的权限，即可正常使用用户选择功能。
