# 部署指南

## 开发环境

### 快速启动
```bash
# 1. 复制环境配置
cp .env.example .env

# 2. 启动所有服务
./scripts/start.sh

# 3. 访问应用
# 前端：http://localhost
# 后端：http://localhost:3000/api/v1/health
# MinIO：http://localhost:9001
```

### 停止服务
```bash
./scripts/stop.sh
```

## 生产环境

### 1. 环境准备
```bash
# 复制生产环境配置
cp .env.prod.example .env.prod

# 编辑配置文件，修改密码和密钥
vim .env.prod
```

### 2. 部署步骤
```bash
# 构建并启动生产环境
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 查看服务状态
docker compose -f docker-compose.prod.yml ps

# 查看日志
docker compose -f docker-compose.prod.yml logs -f
```

### 3. 数据备份
```bash
# 自动备份（推荐）
./scripts/backup.sh

# 指定备份名称
./scripts/backup.sh my_backup_20241201

# Windows PowerShell
.\scripts\backup.ps1
.\scripts\backup.ps1 my_backup_20241201
```

### 4. 数据恢复
```bash
# 查看可用备份
./scripts/restore.sh

# 恢复指定备份
./scripts/restore.sh backup_20241201_143022

# Windows PowerShell
.\scripts\restore.ps1 backup_20241201_143022
```

### 5. 手动备份（高级用户）
```bash
# 备份 MySQL 数据
docker exec project-manager-mysql-1 mysqldump -u root -p project_manager > backup.sql

# 备份 MinIO 数据
docker run --rm -v project-manager_minio-data:/data -v $(pwd):/backup alpine tar czf /backup/minio-backup.tar.gz -C /data .
```

### 6. 手动恢复（高级用户）
```bash
# 恢复 MySQL 数据
docker exec -i project-manager-mysql-1 mysql -u root -p project_manager < backup.sql

# 恢复 MinIO 数据
docker run --rm -v project-manager_minio-data:/data -v $(pwd):/backup alpine tar xzf /backup/minio-backup.tar.gz -C /data
```

### 7. 更新应用
```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

# 清理旧镜像
docker image prune -f
```

## 监控与维护

### 健康检查
- 应用健康：`curl http://localhost/health`
- 数据库：`docker exec project-manager-mysql-1 mysqladmin ping`
- Redis：`docker exec project-manager-redis-1 redis-cli ping`

### 日志查看
```bash
# 查看所有服务日志
docker compose -f docker-compose.prod.yml logs

# 查看特定服务日志
docker compose -f docker-compose.prod.yml logs server
docker compose -f docker-compose.prod.yml logs web
```

### 性能监控
```bash
# 查看资源使用情况
docker stats

# 查看容器详细信息
docker inspect project-manager-server-1
```

## 故障排除

### 常见问题
1. **数据库连接失败**：检查 MySQL 服务是否正常启动
2. **前端无法访问**：检查 Nginx 配置和端口映射
3. **文件上传失败**：检查 MinIO 服务状态和存储空间

### 重置环境
```bash
# 停止所有服务
docker compose -f docker-compose.prod.yml down

# 删除所有数据卷（注意：会丢失所有数据）
docker volume prune -f

# 重新启动
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d
```
