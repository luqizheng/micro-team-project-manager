# GitLab集成功能故障排除指南

## 概述

本文档提供了GitLab集成功能常见问题的诊断和解决方案，帮助您快速定位和解决问题。

## 问题分类

### 1. 连接问题
### 2. 认证问题
### 3. 同步问题
### 4. 性能问题
### 5. 数据问题
### 6. 配置问题

## 连接问题

### 问题1: GitLab实例连接失败

**症状**:
- 测试连接时显示"连接失败"
- 无法获取GitLab项目列表
- API调用超时

**可能原因**:
1. GitLab实例URL不正确
2. 网络连接问题
3. GitLab实例不可访问
4. 防火墙阻止连接
5. SSL证书问题

**诊断步骤**:

1. **检查URL格式**:
```bash
# 确保URL格式正确
curl -I https://gitlab.example.com/api/v4/user
```

2. **检查网络连接**:
```bash
# 测试网络连通性
ping gitlab.example.com
telnet gitlab.example.com 443
```

3. **检查SSL证书**:
```bash
# 检查SSL证书
openssl s_client -connect gitlab.example.com:443 -servername gitlab.example.com
```

4. **检查防火墙**:
```bash
# 检查出站连接
curl -v https://gitlab.example.com/api/v4/user
```

**解决方案**:

1. **修正URL格式**:
   - 确保URL包含协议（https://）
   - 移除末尾的斜杠
   - 检查端口号（默认443）

2. **网络问题**:
   - 检查DNS解析
   - 配置代理服务器
   - 检查防火墙规则

3. **SSL问题**:
   - 更新CA证书
   - 配置SSL验证跳过（仅测试环境）

### 问题2: API令牌无效

**症状**:
- 返回401未授权错误
- 无法访问GitLab API
- 令牌验证失败

**诊断步骤**:

1. **检查令牌格式**:
```bash
# 验证令牌格式
echo "glpat-xxxxxxxxxxxxxxxxxxxx" | wc -c
# 应该返回32个字符
```

2. **检查令牌权限**:
```bash
# 使用curl测试令牌
curl -H "Authorization: Bearer glpat-xxxxxxxxxxxxxxxxxxxx" \
     https://gitlab.example.com/api/v4/user
```

3. **检查令牌状态**:
   - 登录GitLab检查令牌是否被撤销
   - 检查令牌过期时间
   - 验证令牌权限范围

**解决方案**:

1. **重新生成令牌**:
   - 登录GitLab
   - 进入用户设置 > 访问令牌
   - 创建新的Personal Access Token
   - 确保选择正确的权限范围

2. **更新令牌**:
   - 在系统配置中更新API令牌
   - 重新测试连接

### 问题3: Webhook接收失败

**症状**:
- Webhook事件未被接收
- 返回401或403错误
- 事件处理失败

**诊断步骤**:

1. **检查Webhook配置**:
```bash
# 检查GitLab Webhook配置
curl -H "Authorization: Bearer glpat-xxxxxxxxxxxxxxxxxxxx" \
     https://gitlab.example.com/api/v4/projects/123/hooks
```

2. **检查签名验证**:
```bash
# 验证Webhook签名
echo -n '{"test": "data"}' | openssl dgst -sha256 -hmac "webhook-secret"
```

3. **检查网络访问**:
   - 确保GitLab可以访问您的服务器
   - 检查防火墙和NAT配置
   - 验证SSL证书

**解决方案**:

1. **修正Webhook URL**:
   - 确保URL可公开访问
   - 使用HTTPS协议
   - 检查URL路径正确

2. **配置签名验证**:
   - 设置强密钥
   - 确保密钥一致性
   - 启用签名验证

## 认证问题

### 问题4: JWT令牌验证失败

**症状**:
- 返回401未授权错误
- 无法访问受保护的API
- 令牌过期错误

**诊断步骤**:

1. **检查令牌格式**:
```javascript
// 解码JWT令牌
const jwt = require('jsonwebtoken');
const token = 'your-jwt-token';
const decoded = jwt.decode(token);
console.log(decoded);
```

2. **检查令牌过期**:
```javascript
// 检查过期时间
const now = Math.floor(Date.now() / 1000);
if (decoded.exp < now) {
    console.log('Token expired');
}
```

3. **检查签名**:
```javascript
// 验证签名
try {
    const verified = jwt.verify(token, 'your-secret-key');
    console.log('Token is valid');
} catch (error) {
    console.log('Token verification failed:', error.message);
}
```

**解决方案**:

1. **重新登录**:
   - 清除浏览器缓存
   - 重新登录系统
   - 获取新的JWT令牌

2. **检查系统时间**:
   - 确保服务器时间正确
   - 同步NTP时间
   - 检查时区设置

### 问题5: 权限不足

**症状**:
- 返回403禁止访问错误
- 无法执行某些操作
- 权限验证失败

**诊断步骤**:

1. **检查用户角色**:
```sql
-- 查询用户角色
SELECT id, username, role FROM users WHERE id = 'user-id';
```

2. **检查权限配置**:
```javascript
// 检查权限配置
const permissions = {
    'system_admin': ['read:gitlab_instance', 'create:gitlab_instance'],
    'project_manager': ['read:gitlab_instance', 'read:gitlab_project_mapping'],
    'user': ['read:gitlab_instance']
};
```

3. **检查资源权限**:
   - 验证用户是否有权限访问特定资源
   - 检查项目级别的权限
   - 验证实例级别的权限

**解决方案**:

1. **更新用户角色**:
   - 联系系统管理员
   - 更新用户权限
   - 重新分配角色

2. **检查资源所有权**:
   - 确保用户有权限访问资源
   - 检查项目成员关系
   - 验证实例访问权限

## 同步问题

### 问题6: 数据同步失败

**症状**:
- 同步任务失败
- 数据不一致
- 同步错误日志

**诊断步骤**:

1. **检查同步日志**:
```bash
# 查看同步日志
tail -f logs/sync.log | grep ERROR
```

2. **检查数据映射**:
```sql
-- 检查项目映射
SELECT * FROM gitlab_project_mappings WHERE is_active = 1;
```

3. **检查同步状态**:
```sql
-- 检查同步状态
SELECT * FROM gitlab_sync_statuses WHERE status = 'failed';
```

**解决方案**:

1. **重新配置映射**:
   - 检查字段映射配置
   - 验证数据类型匹配
   - 更新映射规则

2. **手动重试同步**:
   - 使用管理界面重试失败的任务
   - 检查错误详情
   - 修复数据问题后重试

### 问题7: 事件处理失败

**症状**:
- Webhook事件处理失败
- 事件队列积压
- 处理超时

**诊断步骤**:

1. **检查事件队列**:
```bash
# 检查Redis队列
redis-cli llen gitlab:events:queue
```

2. **检查事件日志**:
```sql
-- 查询失败的事件
SELECT * FROM gitlab_event_logs WHERE status = 'failed' ORDER BY created_at DESC LIMIT 10;
```

3. **检查处理性能**:
```bash
# 检查CPU和内存使用
top -p $(pgrep -f "gitlab-integration")
```

**解决方案**:

1. **优化事件处理**:
   - 增加处理并发数
   - 优化处理逻辑
   - 调整超时设置

2. **清理失败事件**:
   - 删除过期的失败事件
   - 重试可恢复的事件
   - 修复数据问题

## 性能问题

### 问题8: 响应时间过长

**症状**:
- API响应缓慢
- 页面加载时间长
- 超时错误

**诊断步骤**:

1. **检查响应时间**:
```bash
# 测试API响应时间
curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:3000/api/gitlab/instances"
```

2. **检查数据库性能**:
```sql
-- 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看慢查询日志
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

3. **检查内存使用**:
```bash
# 检查内存使用
free -h
ps aux --sort=-%mem | head -10
```

**解决方案**:

1. **数据库优化**:
   - 添加适当的索引
   - 优化查询语句
   - 调整数据库配置

2. **应用优化**:
   - 启用缓存
   - 优化代码逻辑
   - 增加服务器资源

### 问题9: 内存泄漏

**症状**:
- 内存使用持续增长
- 应用崩溃
- 性能下降

**诊断步骤**:

1. **监控内存使用**:
```bash
# 持续监控内存
watch -n 1 'ps aux --sort=-%mem | head -10'
```

2. **检查堆内存**:
```bash
# 生成堆转储
node --inspect=0.0.0.0:9229 dist/main.js
# 使用Chrome DevTools分析
```

3. **检查垃圾回收**:
```bash
# 启用GC日志
node --trace-gc dist/main.js
```

**解决方案**:

1. **代码优化**:
   - 修复内存泄漏
   - 优化对象创建
   - 及时释放资源

2. **配置优化**:
   - 调整内存限制
   - 启用垃圾回收优化
   - 配置内存监控

## 数据问题

### 问题10: 数据不一致

**症状**:
- GitLab和系统数据不同步
- 字段映射错误
- 数据丢失

**诊断步骤**:

1. **比较数据**:
```sql
-- 比较同步状态
SELECT 
    p.id as project_id,
    p.name as project_name,
    s.last_sync_at,
    s.status
FROM projects p
LEFT JOIN gitlab_sync_statuses s ON p.id = s.project_id;
```

2. **检查映射配置**:
```sql
-- 检查字段映射
SELECT 
    project_id,
    field_mapping,
    sync_config
FROM gitlab_project_mappings
WHERE is_active = 1;
```

3. **验证数据完整性**:
```sql
-- 检查数据完整性
SELECT COUNT(*) as total_issues FROM issues;
SELECT COUNT(*) as synced_issues FROM issues WHERE external_id IS NOT NULL;
```

**解决方案**:

1. **重新同步数据**:
   - 执行全量同步
   - 验证数据映射
   - 检查同步日志

2. **修复数据**:
   - 手动修复错误数据
   - 更新映射配置
   - 重新建立映射关系

### 问题11: 数据丢失

**症状**:
- 数据意外删除
- 同步后数据消失
- 备份数据损坏

**诊断步骤**:

1. **检查删除日志**:
```sql
-- 检查删除操作
SELECT * FROM audit_logs WHERE action = 'DELETE' ORDER BY created_at DESC;
```

2. **检查备份**:
```bash
# 检查备份文件
ls -la /opt/backups/gitlab-integration/
```

3. **检查同步配置**:
```sql
-- 检查同步配置
SELECT * FROM gitlab_project_mappings WHERE sync_config LIKE '%delete%';
```

**解决方案**:

1. **恢复数据**:
   - 从备份恢复数据
   - 重新同步丢失的数据
   - 验证数据完整性

2. **防止数据丢失**:
   - 启用软删除
   - 配置数据保护
   - 定期备份数据

## 配置问题

### 问题12: 配置错误

**症状**:
- 应用启动失败
- 功能异常
- 配置验证失败

**诊断步骤**:

1. **检查环境变量**:
```bash
# 检查环境变量
env | grep GITLAB
env | grep DATABASE
env | grep REDIS
```

2. **验证配置文件**:
```bash
# 检查配置文件语法
node -c config/database.js
node -c config/redis.js
```

3. **检查依赖服务**:
```bash
# 检查数据库连接
mysql -u username -p -h localhost database_name

# 检查Redis连接
redis-cli ping
```

**解决方案**:

1. **修正配置**:
   - 检查配置文件格式
   - 验证环境变量
   - 更新配置值

2. **重启服务**:
   - 重启应用服务
   - 重启依赖服务
   - 验证配置生效

### 问题13: 依赖服务不可用

**症状**:
- 数据库连接失败
- Redis连接失败
- 外部API不可用

**诊断步骤**:

1. **检查服务状态**:
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 检查Redis状态
sudo systemctl status redis-server
```

2. **检查网络连接**:
```bash
# 检查端口监听
netstat -tlnp | grep :3306
netstat -tlnp | grep :6379
```

3. **检查服务日志**:
```bash
# 查看MySQL日志
sudo tail -f /var/log/mysql/error.log

# 查看Redis日志
sudo tail -f /var/log/redis/redis-server.log
```

**解决方案**:

1. **重启服务**:
   - 重启数据库服务
   - 重启Redis服务
   - 重启应用服务

2. **修复配置**:
   - 检查服务配置
   - 修复连接参数
   - 更新访问权限

## 监控和预防

### 1. 设置监控

```bash
# 创建监控脚本
cat > /opt/gitlab-integration/monitor.sh << 'EOF'
#!/bin/bash

# 检查应用状态
if ! curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "$(date): Application is down" >> /var/log/gitlab-integration/monitor.log
    # 发送告警
    curl -X POST -H 'Content-type: application/json' \
         --data '{"text":"GitLab Integration is down!"}' \
         https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
fi

# 检查数据库连接
if ! mysql -u username -p'password' -e "SELECT 1" > /dev/null 2>&1; then
    echo "$(date): Database connection failed" >> /var/log/gitlab-integration/monitor.log
fi

# 检查Redis连接
if ! redis-cli ping > /dev/null 2>&1; then
    echo "$(date): Redis connection failed" >> /var/log/gitlab-integration/monitor.log
fi
EOF

chmod +x /opt/gitlab-integration/monitor.sh

# 设置定时任务
echo "*/5 * * * * /opt/gitlab-integration/monitor.sh" | crontab -
```

### 2. 日志分析

```bash
# 创建日志分析脚本
cat > /opt/gitlab-integration/log-analysis.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/gitlab-integration/app.log"

# 统计错误数量
ERROR_COUNT=$(grep -c "ERROR" $LOG_FILE)
echo "Error count: $ERROR_COUNT"

# 统计警告数量
WARN_COUNT=$(grep -c "WARN" $LOG_FILE)
echo "Warning count: $WARN_COUNT"

# 统计API调用
API_CALLS=$(grep -c "API call" $LOG_FILE)
echo "API calls: $API_CALLS"

# 统计同步操作
SYNC_OPS=$(grep -c "Sync operation" $LOG_FILE)
echo "Sync operations: $SYNC_OPS"
EOF

chmod +x /opt/gitlab-integration/log-analysis.sh
```

### 3. 性能监控

```bash
# 创建性能监控脚本
cat > /opt/gitlab-integration/performance-monitor.sh << 'EOF'
#!/bin/bash

# 检查CPU使用率
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')
echo "CPU usage: $CPU_USAGE%"

# 检查内存使用率
MEMORY_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
echo "Memory usage: $MEMORY_USAGE%"

# 检查磁盘使用率
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
echo "Disk usage: $DISK_USAGE%"

# 检查网络连接数
CONNECTIONS=$(netstat -an | grep :3000 | wc -l)
echo "Active connections: $CONNECTIONS"
EOF

chmod +x /opt/gitlab-integration/performance-monitor.sh
```

## 联系支持

如果以上解决方案都无法解决您的问题，请联系技术支持：

- **技术支持邮箱**: support@yourcompany.com
- **紧急联系电话**: +86-xxx-xxxx-xxxx
- **在线支持**: https://support.yourcompany.com
- **文档中心**: https://docs.yourcompany.com

请提供以下信息：
1. 问题描述
2. 错误日志
3. 系统环境信息
4. 复现步骤
5. 已尝试的解决方案

## 总结

本故障排除指南涵盖了GitLab集成功能的主要问题类型和解决方案。通过系统性的诊断和解决步骤，您可以快速定位和解决大部分常见问题。

记住定期备份数据、监控系统状态，并保持应用程序和依赖服务的更新，以确保系统的稳定运行。
