# GitLab集成功能部署指南

## 概述

本文档详细描述了GitLab集成功能的部署流程，包括环境准备、配置、部署步骤、监控和维护等内容。

## 系统要求

### 硬件要求

**最低配置**:
- CPU: 2核心
- 内存: 4GB RAM
- 存储: 20GB 可用空间
- 网络: 100Mbps 带宽

**推荐配置**:
- CPU: 4核心
- 内存: 8GB RAM
- 存储: 50GB 可用空间
- 网络: 1Gbps 带宽

### 软件要求

**操作系统**:
- Ubuntu 20.04 LTS 或更高版本
- CentOS 8 或更高版本
- Windows Server 2019 或更高版本

**运行时环境**:
- Node.js 18.x 或更高版本
- MySQL 8.0 或更高版本
- Redis 6.0 或更高版本
- Docker 20.10 或更高版本（可选）

## 环境准备

### 1. 安装Node.js

```bash
# 使用NodeSource仓库安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

### 2. 安装MySQL

```bash
# 安装MySQL
sudo apt-get update
sudo apt-get install mysql-server

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 3. 安装Redis

```bash
# 安装Redis
sudo apt-get install redis-server

# 启动Redis服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证安装
redis-cli ping
```

### 4. 安装PM2（进程管理）

```bash
# 全局安装PM2
npm install -g pm2

# 验证安装
pm2 --version
```

## 配置

### 1. 环境变量配置

创建 `.env` 文件：

```bash
# 数据库配置
DATABASE_URL=mysql://username:password@localhost:3306/gitlab_integration
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=gitlab_integration
DB_PASSWORD=your_secure_password
DB_DATABASE=gitlab_integration

# Redis配置
REDIS_URL=redis://localhost:6379
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=24h

# 应用配置
NODE_ENV=production
PORT=3000
API_PREFIX=api

# GitLab集成配置
GITLAB_WEBHOOK_SECRET=your_webhook_secret
GITLAB_API_TIMEOUT=30000
GITLAB_RETRY_COUNT=3

# 日志配置
LOG_LEVEL=info
LOG_FILE=logs/app.log

# 监控配置
ENABLE_METRICS=true
METRICS_PORT=9090
```

### 2. 数据库配置

创建数据库和用户：

```sql
-- 创建数据库
CREATE DATABASE gitlab_integration CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'gitlab_integration'@'localhost' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON gitlab_integration.* TO 'gitlab_integration'@'localhost';
FLUSH PRIVILEGES;
```

### 3. Redis配置

编辑Redis配置文件 `/etc/redis/redis.conf`：

```conf
# 绑定地址
bind 127.0.0.1

# 端口
port 6379

# 密码（可选）
# requirepass your_redis_password

# 持久化配置
save 900 1
save 300 10
save 60 10000

# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru
```

## 部署步骤

### 1. 代码部署

```bash
# 克隆代码
git clone https://github.com/your-org/micro-team-project-manager.git
cd micro-team-project-manager

# 安装依赖
npm install

# 构建项目
npm run build
```

### 2. 数据库迁移

```bash
# 运行数据库迁移
npm run migration:run

# 验证迁移
npm run migration:show
```

### 3. 启动服务

#### 使用PM2启动

```bash
# 创建PM2配置文件
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'gitlab-integration',
    script: 'dist/main.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: 'logs/err.log',
    out_file: 'logs/out.log',
    log_file: 'logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
EOF

# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save
pm2 startup
```

#### 使用Docker启动

```bash
# 构建Docker镜像
docker build -t gitlab-integration .

# 运行容器
docker run -d \
  --name gitlab-integration \
  -p 3000:3000 \
  --env-file .env \
  --restart unless-stopped \
  gitlab-integration
```

### 4. 配置反向代理

#### 使用Nginx

创建Nginx配置文件 `/etc/nginx/sites-available/gitlab-integration`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 客户端最大请求体大小
    client_max_body_size 10M;

    # 代理配置
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Webhook端点特殊配置
    location /api/gitlab/webhook/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
    }
}
```

启用配置：

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/gitlab-integration /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 监控和日志

### 1. 日志配置

创建日志目录：

```bash
mkdir -p logs
chmod 755 logs
```

配置日志轮转 `/etc/logrotate.d/gitlab-integration`：

```
/path/to/your/app/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 app app
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 2. 监控配置

#### 使用Prometheus监控

安装Prometheus：

```bash
# 下载Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xvfz prometheus-2.40.0.linux-amd64.tar.gz
sudo mv prometheus-2.40.0.linux-amd64 /opt/prometheus
sudo useradd --no-create-home --shell /bin/false prometheus
sudo chown -R prometheus:prometheus /opt/prometheus
```

创建Prometheus配置文件 `/opt/prometheus/prometheus.yml`：

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'gitlab-integration'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s
    metrics_path: /metrics
```

#### 使用Grafana可视化

安装Grafana：

```bash
# 添加Grafana仓库
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list

# 安装Grafana
sudo apt-get update
sudo apt-get install grafana

# 启动Grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server
```

### 3. 健康检查

创建健康检查脚本 `/opt/gitlab-integration/health-check.sh`：

```bash
#!/bin/bash

# 健康检查脚本
APP_URL="http://localhost:3000/api/health"
LOG_FILE="/var/log/gitlab-integration/health-check.log"

# 检查应用状态
response=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)

if [ $response -eq 200 ]; then
    echo "$(date): Application is healthy" >> $LOG_FILE
    exit 0
else
    echo "$(date): Application is unhealthy (HTTP $response)" >> $LOG_FILE
    exit 1
fi
```

设置定时任务：

```bash
# 添加到crontab
echo "*/5 * * * * /opt/gitlab-integration/health-check.sh" | crontab -
```

## 安全配置

### 1. 防火墙配置

```bash
# 安装UFW
sudo apt-get install ufw

# 配置防火墙规则
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3000/tcp  # 仅用于本地访问
sudo ufw enable
```

### 2. SSL证书配置

使用Let's Encrypt获取免费SSL证书：

```bash
# 安装Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 3. 数据库安全

```sql
-- 创建只读用户用于监控
CREATE USER 'gitlab_integration_readonly'@'localhost' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON gitlab_integration.* TO 'gitlab_integration_readonly'@'localhost';

-- 限制连接数
SET GLOBAL max_connections = 100;

-- 启用查询日志
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/log/mysql/general.log';
```

## 备份和恢复

### 1. 数据库备份

创建备份脚本 `/opt/gitlab-integration/backup-db.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/opt/backups/gitlab-integration"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="gitlab_integration"
DB_USER="gitlab_integration"
DB_PASS="your_secure_password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/gitlab_integration_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/gitlab_integration_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Database backup completed: gitlab_integration_$DATE.sql.gz"
```

### 2. 应用备份

创建应用备份脚本 `/opt/gitlab-integration/backup-app.sh`：

```bash
#!/bin/bash

APP_DIR="/opt/gitlab-integration"
BACKUP_DIR="/opt/backups/gitlab-integration"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份应用文件
tar -czf $BACKUP_DIR/app_$DATE.tar.gz -C $APP_DIR .

# 删除7天前的备份
find $BACKUP_DIR -name "app_*.tar.gz" -mtime +7 -delete

echo "Application backup completed: app_$DATE.tar.gz"
```

### 3. 自动备份

设置定时备份：

```bash
# 添加到crontab
echo "0 2 * * * /opt/gitlab-integration/backup-db.sh" | crontab -
echo "0 3 * * * /opt/gitlab-integration/backup-app.sh" | crontab -
```

## 维护和更新

### 1. 应用更新

```bash
# 停止应用
pm2 stop gitlab-integration

# 备份当前版本
cp -r /opt/gitlab-integration /opt/gitlab-integration.backup.$(date +%Y%m%d)

# 更新代码
cd /opt/gitlab-integration
git pull origin main

# 安装依赖
npm install

# 构建应用
npm run build

# 运行数据库迁移
npm run migration:run

# 启动应用
pm2 start gitlab-integration

# 验证更新
pm2 logs gitlab-integration
```

### 2. 数据库维护

```sql
-- 优化数据库
OPTIMIZE TABLE gitlab_instances;
OPTIMIZE TABLE gitlab_project_mappings;
OPTIMIZE TABLE gitlab_event_logs;
OPTIMIZE TABLE gitlab_user_mappings;
OPTIMIZE TABLE gitlab_sync_statuses;

-- 清理旧数据
DELETE FROM gitlab_event_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 3. 日志清理

```bash
# 清理应用日志
find /opt/gitlab-integration/logs -name "*.log" -mtime +30 -delete

# 清理系统日志
sudo journalctl --vacuum-time=30d
```

## 故障排除

### 1. 常见问题

**应用无法启动**:
```bash
# 检查端口占用
sudo netstat -tlnp | grep :3000

# 检查日志
pm2 logs gitlab-integration

# 检查环境变量
pm2 env gitlab-integration
```

**数据库连接失败**:
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 检查数据库连接
mysql -u gitlab_integration -p -h localhost gitlab_integration

# 检查防火墙
sudo ufw status
```

**Redis连接失败**:
```bash
# 检查Redis状态
sudo systemctl status redis-server

# 检查Redis连接
redis-cli ping

# 检查Redis日志
sudo tail -f /var/log/redis/redis-server.log
```

### 2. 性能调优

**数据库优化**:
```sql
-- 调整缓冲池大小
SET GLOBAL innodb_buffer_pool_size = 2G;

-- 调整连接数
SET GLOBAL max_connections = 200;

-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
```

**应用优化**:
```bash
# 调整PM2配置
pm2 restart gitlab-integration --max-memory-restart 2G

# 启用集群模式
pm2 start ecosystem.config.js --instances max
```

## 监控告警

### 1. 设置告警规则

创建告警脚本 `/opt/gitlab-integration/alert.sh`：

```bash
#!/bin/bash

# 检查应用状态
if ! curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    # 发送告警邮件
    echo "GitLab Integration is down!" | mail -s "Alert: Service Down" admin@yourcompany.com
    
    # 尝试重启服务
    pm2 restart gitlab-integration
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is ${DISK_USAGE}%" | mail -s "Alert: High Disk Usage" admin@yourcompany.com
fi

# 检查内存使用
MEMORY_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    echo "Memory usage is ${MEMORY_USAGE}%" | mail -s "Alert: High Memory Usage" admin@yourcompany.com
fi
```

### 2. 设置定时检查

```bash
# 添加到crontab
echo "*/5 * * * * /opt/gitlab-integration/alert.sh" | crontab -
```

## 总结

本部署指南提供了GitLab集成功能的完整部署流程。通过遵循这些步骤，您可以成功部署和维护一个稳定、安全的GitLab集成系统。

记住定期备份数据、监控系统状态，并及时更新应用程序以保持系统的最佳性能和安全性。
