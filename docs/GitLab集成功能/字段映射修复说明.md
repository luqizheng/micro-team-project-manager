# GitLab实例字段映射修复说明

## 问题描述

在GitLab集成功能中，前端提交的数据字段名与后端DTO期望的字段名不一致，导致API调用失败。

### 字段不匹配问题

| 字段用途 | 前端提交 | 后端期望 | 数据库存储 |
|---------|---------|---------|-----------|
| 实例URL | `url` | `baseUrl` | `baseUrl` |
| 访问令牌 | `accessToken` | `apiToken` | `apiToken` |
| 实例类型 | `type` | `instanceType` | `instanceType` |
| 描述 | `description` | ❌ 不存在 | ❌ 不存在 |
| 同步配置 | `syncConfig` | ❌ 不存在 | ❌ 不存在 |
| 高级配置 | `advancedConfig` | ❌ 不存在 | ❌ 不存在 |

## 修复方案

采用**后端适配前端**的策略，修改后端DTO以匹配前端提交的字段名，确保API接口的一致性。

### 修复内容

#### 1. 更新CreateGitLabInstanceDto

**文件**: `server/src/modules/gitlab-integration/dto/create-gitlab-instance.dto.ts`

**修改内容**:
- `baseUrl` → `url`
- `apiToken` → `accessToken`  
- `instanceType` → `type`
- 新增 `description` 字段
- 新增 `syncConfig` 字段
- 新增 `advancedConfig` 字段

#### 2. 更新UpdateGitLabInstanceDto

**文件**: `server/src/modules/gitlab-integration/dto/update-gitlab-instance.dto.ts`

**修改内容**:
- `baseUrl` → `url`
- `apiToken` → `accessToken`
- `instanceType` → `type`
- 新增 `description` 字段
- 新增 `syncConfig` 字段
- 新增 `advancedConfig` 字段

#### 3. 更新GitLabInstanceResponseDto

**文件**: `server/src/modules/gitlab-integration/dto/gitlab-instance-response.dto.ts`

**修改内容**:
- `baseUrl` → `url`
- `apiToken` → `accessToken`
- `instanceType` → `type`

#### 4. 更新服务层字段映射

**文件**: `server/src/modules/gitlab-integration/services/gitlab-integration.service.ts`

**修改内容**:

##### createInstance方法
```typescript
// 字段映射：前端字段 -> 数据库字段
const instance = this.gitlabInstanceRepository.create({
  name: dto.name,
  baseUrl: dto.url, // 前端 url -> 数据库 baseUrl
  apiToken: encryptedToken, // 前端 accessToken -> 数据库 apiToken
  webhookSecret: dto.webhookSecret || this.generateWebhookSecret(),
  instanceType: dto.type || "self_hosted", // 前端 type -> 数据库 instanceType
  isActive: dto.isActive !== false,
});
```

##### updateInstance方法
```typescript
// 更新字段 - 字段映射：前端字段 -> 数据库字段
if (dto.name) instance.name = dto.name;
if (dto.url) instance.baseUrl = dto.url; // 前端 url -> 数据库 baseUrl
if (dto.accessToken) {
  instance.apiToken = this.encryptApiToken(dto.accessToken);
}
if (dto.webhookSecret !== undefined)
  instance.webhookSecret = dto.webhookSecret;
if (dto.type)
  instance.instanceType = dto.type; // 前端 type -> 数据库 instanceType
if (dto.isActive !== undefined)
  instance.isActive = dto.isActive;
```

##### mapInstanceToResponse方法
```typescript
// 字段映射：数据库字段 -> 前端期望字段
return {
  id: instance.id,
  name: instance.name,
  url: instance.baseUrl, // 数据库 baseUrl -> 前端 url
  accessToken: instance.apiToken
    ? `${instance.apiToken.substring(0, 4)}****`
    : "", // 数据库 apiToken -> 前端 accessToken
  webhookSecret: instance.webhookSecret
    ? `${instance.webhookSecret.substring(0, 4)}****`
    : undefined,
  isActive: instance.isActive,
  type: instance.instanceType, // 数据库 instanceType -> 前端 type
  // ... 其他字段
};
```

## 数据流向

```
前端表单 → CreateGitLabInstanceDto → 服务层字段映射 → 数据库实体
   ↓
GitLabInstanceResponseDto ← 服务层字段映射 ← 数据库实体
   ↓
前端接收
```

## 测试验证

创建了测试脚本 `scripts/test-gitlab-instance-api.ps1` 来验证修复效果：

1. 测试创建GitLab实例API
2. 测试获取GitLab实例API  
3. 验证字段映射正确性
4. 测试更新GitLab实例API
5. 清理测试数据

## 影响范围

- ✅ 前端无需修改
- ✅ 数据库结构无需修改
- ✅ 现有API接口保持兼容
- ✅ 新增字段支持前端扩展功能

## 注意事项

1. **字段映射**: 在服务层进行字段映射，确保前端和后端字段名的一致性
2. **向后兼容**: 保持数据库实体字段名不变，避免数据库迁移
3. **安全性**: 访问令牌仍然进行加密存储和脱敏显示
4. **扩展性**: 新增字段为前端功能扩展提供了支持

## 修复结果

- ✅ 前端提交的数据能正确被后端接收
- ✅ 后端返回的数据格式符合前端期望
- ✅ API接口调用成功
- ✅ 字段映射逻辑清晰明确
- ✅ 代码可维护性良好
