# GitLab集成功能用户使用指南

## 概述

GitLab集成功能允许您将项目管理工具与GitLab实例连接，实现项目、问题、合并请求、流水线等数据的自动同步。本指南将帮助您快速上手并充分利用这些功能。

## 功能特性

- **多实例支持**: 支持连接多个GitLab实例（自托管和GitLab.com）
- **实时同步**: 通过Webhook实现实时数据同步
- **项目映射**: 将内部项目与GitLab项目建立映射关系
- **用户同步**: 自动同步GitLab用户信息
- **事件管理**: 完整的事件处理和重试机制
- **权限控制**: 基于角色的细粒度权限管理

## 快速开始

### 配置前准备

在开始配置之前，请确保您已准备好以下信息：

- **GitLab实例URL**：您的GitLab实例地址
- **Personal Access Token**：具有适当权限的API令牌
- **Webhook密钥**：用于验证Webhook事件的安全密钥
- **项目管理工具权限**：系统管理员或项目管理员权限

### 1. 访问GitLab集成页面

1. 登录项目管理工具
2. 在左侧导航菜单中点击"GitLab集成"
3. 确保您有相应的权限（系统管理员或项目管理员）

### 2. 添加GitLab实例

1. 在"GitLab实例"标签页中点击"添加GitLab实例"
2. 填写实例信息：
   - **实例名称**: 便于识别的名称
   - **实例URL**: GitLab实例的完整URL
   - **访问令牌**: 具有适当权限的Personal Access Token
   - **Webhook密钥**: 用于验证Webhook事件的密钥
   - **实例类型**: 选择"自托管"或"GitLab.com"
3. 配置同步选项：
   - 同步用户信息
   - 同步问题
   - 同步合并请求
   - 同步流水线
4. 点击"测试连接"验证配置
5. 点击"创建"完成实例添加

### 3. 创建项目映射

1. 切换到"项目映射"标签页
2. 点击"添加映射"
3. 选择要映射的内部项目
4. 选择GitLab实例
5. 选择GitLab项目
6. 配置字段映射和同步选项
7. 点击"创建"完成映射

### 4. 配置GitLab Webhook（重要）

完成项目映射后，需要在GitLab中配置Webhook以实现实时同步：

1. 登录您的GitLab实例
2. 进入已映射的GitLab项目
3. 导航到 **Settings** → **Webhooks**
4. 添加新的Webhook：
   - **URL**: `https://your-pm-domain.com/api/gitlab/webhook`
   - **Secret Token**: 使用在步骤2中设置的Webhook密钥
   - **Trigger**: 选择以下事件
     - Push events
     - Issues events
     - Merge request events
     - Pipeline events
5. 点击"Add webhook"保存配置
6. 测试Webhook连接确保配置正确

### 5. 执行初始同步

配置完成后，执行初始数据同步：

1. 切换到"同步管理"标签页
2. 选择已配置的GitLab实例
3. 选择"全量同步"类型
4. 选择要同步的项目映射
5. 点击"开始同步"启动初始同步
6. 监控同步进度直到完成

## 完整使用流程

### 配置完成后的日常使用流程

#### 1. 项目管理流程

**在项目管理工具中创建和管理任务**：
1. 登录项目管理工具
2. 进入已映射的项目
3. 创建新的Issue或任务
4. 系统会自动同步到GitLab（如果配置了双向同步）

**在GitLab中创建和管理Issue**：
1. 在GitLab项目中创建Issue
2. 系统通过Webhook自动接收事件
3. 在项目管理工具中查看同步的Issue
4. 在项目管理工具中更新Issue状态
5. 状态变更会自动同步回GitLab

#### 2. 开发工作流程

**代码开发流程**：
1. 在GitLab中创建Feature分支
2. 开发完成后创建Merge Request
3. 系统自动同步MR信息到项目管理工具
4. 在项目管理工具中跟踪MR状态
5. 代码合并后，相关Issue状态自动更新

**Pipeline监控**：
1. GitLab Pipeline执行时触发Webhook
2. 系统自动同步Pipeline状态
3. 在项目管理工具中查看构建状态
4. 构建失败时自动更新相关Issue状态

#### 3. 团队协作流程

**任务分配和跟踪**：
1. 项目经理在项目管理工具中分配任务
2. 任务自动同步到GitLab Issue
3. 开发人员在GitLab中查看和更新任务
4. 更新自动同步回项目管理工具
5. 项目经理实时跟踪任务进度

**代码审查流程**：
1. 开发人员提交Merge Request
2. 系统自动创建代码审查任务
3. 审查人员在GitLab中进行代码审查
4. 审查结果同步到项目管理工具
5. 项目状态根据审查结果自动更新

#### 4. 报告和分析

**项目报告**：
1. 在项目管理工具中查看项目统计
2. 查看GitLab集成数据（提交次数、MR数量等）
3. 生成包含GitLab数据的综合报告
4. 导出数据用于进一步分析

**团队效率分析**：
1. 查看开发活动统计
2. 分析代码提交频率
3. 跟踪Issue解决时间
4. 监控Pipeline成功率

## 详细功能说明

### GitLab实例管理

#### 创建实例

在添加GitLab实例时，需要提供以下信息：

**基本信息**:
- **实例名称**: 用于标识的友好名称
- **实例URL**: GitLab实例的完整URL（如：https://gitlab.example.com）
- **访问令牌**: 具有API访问权限的Personal Access Token
- **Webhook密钥**: 用于验证Webhook事件的安全密钥
- **实例类型**: 
  - 自托管：您自己部署的GitLab实例
  - GitLab.com：GitLab官方云服务

**同步配置**:
- **同步用户信息**: 自动同步GitLab用户到系统
- **同步问题**: 同步GitLab Issues到内部问题系统
- **同步合并请求**: 同步Merge Requests信息
- **同步流水线**: 同步Pipeline执行状态

**高级配置**:
- **API超时时间**: 与GitLab API通信的超时时间（秒）
- **重试次数**: API调用失败时的重试次数

#### 管理实例

- **查看实例**: 在实例列表中查看所有已配置的实例
- **编辑实例**: 修改实例配置信息
- **测试连接**: 验证实例连接是否正常
- **删除实例**: 移除不再需要的实例

### 项目映射管理

#### 创建映射

项目映射将内部项目与GitLab项目关联，实现数据同步：

1. **选择项目**: 从下拉列表中选择要映射的内部项目
2. **选择实例**: 选择要连接的GitLab实例
3. **选择GitLab项目**: 从实例中获取的项目列表中选择
4. **配置同步**: 设置要同步的数据类型
5. **字段映射**: 配置字段对应关系

#### 字段映射配置

字段映射定义了GitLab数据与内部数据的对应关系：

- **标题字段**: GitLab Issue标题对应的字段
- **描述字段**: GitLab Issue描述对应的字段
- **负责人字段**: GitLab Issue负责人对应的字段
- **标签字段**: GitLab Issue标签对应的字段

#### 管理映射

- **查看映射**: 查看所有项目映射关系
- **编辑映射**: 修改映射配置
- **同步映射**: 手动触发数据同步
- **删除映射**: 移除映射关系

### 同步管理

#### 同步类型

系统支持三种同步类型：

1. **增量同步**: 只同步自上次同步以来的变更
2. **全量同步**: 同步所有数据
3. **补偿同步**: 重新同步失败的数据

#### 执行同步

1. 切换到"同步管理"标签页
2. 选择要同步的GitLab实例
3. 选择同步类型
4. 可选择特定项目进行同步
5. 点击相应的同步按钮启动同步

#### 监控同步状态

- **实时状态**: 查看当前同步任务状态
- **历史记录**: 查看历史同步记录
- **错误日志**: 查看同步过程中的错误信息

### 事件管理

#### 事件类型

系统处理以下类型的GitLab事件：

- **Push事件**: 代码推送事件
- **Merge Request事件**: 合并请求事件
- **Issue事件**: 问题创建、更新、关闭事件
- **Pipeline事件**: 流水线执行事件

#### 事件处理

- **自动处理**: 系统自动处理接收到的Webhook事件
- **重试机制**: 失败的事件会自动重试
- **手动重试**: 可以手动重试失败的事件
- **批量重试**: 可以批量重试多个事件

#### 事件监控

- **事件统计**: 查看事件处理统计信息
- **健康状态**: 监控事件处理系统健康状态
- **错误分析**: 分析事件处理失败的原因

### 权限管理

#### 角色权限

系统定义了以下角色及其权限：

**系统管理员 (system_admin)**:
- 所有GitLab集成功能权限
- 实例管理权限
- 全局同步权限
- 权限配置权限

**项目管理员 (project_manager)**:
- 项目映射管理权限
- 项目级同步权限
- 统计查看权限

**普通用户 (user)**:
- 统计查看权限
- 健康检查权限

#### 权限配置

系统管理员可以配置：

- **启用权限检查**: 是否启用权限验证
- **细粒度权限**: 是否启用细粒度权限控制
- **默认策略**: 未明确权限时的默认策略
- **缓存时间**: 权限信息缓存时间

#### 权限测试

- **权限检查**: 测试特定权限是否有效
- **上下文测试**: 测试特定上下文下的权限
- **用户权限摘要**: 查看用户的完整权限信息

## 配置完成后的使用场景

### 典型使用场景

#### 场景1：新项目启动
1. **项目初始化**：
   - 在项目管理工具中创建新项目
   - 在GitLab中创建对应的代码仓库
   - 建立项目映射关系
   - 配置Webhook和初始同步

2. **团队协作设置**：
   - 同步GitLab用户到项目管理工具
   - 设置项目权限和角色
   - 配置通知和提醒规则

#### 场景2：日常开发工作
1. **需求管理**：
   - 在项目管理工具中创建用户故事和任务
   - 任务自动同步到GitLab Issue
   - 开发人员在GitLab中查看和更新任务

2. **代码开发**：
   - 在GitLab中创建Feature分支
   - 开发完成后创建Merge Request
   - MR信息自动同步到项目管理工具
   - 项目经理跟踪开发进度

3. **质量保证**：
   - Pipeline执行状态实时同步
   - 代码审查结果自动更新
   - 测试结果影响任务状态

#### 场景3：项目交付
1. **版本发布**：
   - 在GitLab中创建Release
   - 发布信息同步到项目管理工具
   - 相关任务自动标记为完成

2. **项目报告**：
   - 生成包含GitLab数据的项目报告
   - 分析开发效率和代码质量
   - 导出数据用于进一步分析

### 数据同步说明

#### 同步方向
- **GitLab → 项目管理工具**：Issue、MR、Pipeline、用户信息
- **项目管理工具 → GitLab**：Issue状态、评论、标签（如果启用双向同步）

#### 同步时机
- **实时同步**：通过Webhook实现，延迟通常在几秒内
- **定时同步**：系统定期执行增量同步，确保数据一致性
- **手动同步**：可以随时手动触发同步

#### 数据映射
- **Issue字段映射**：标题、描述、状态、负责人、标签
- **用户映射**：GitLab用户与项目管理工具用户关联
- **项目映射**：内部项目与GitLab项目一对一关联

## 最佳实践

### 1. 实例配置

- **使用专用令牌**: 为集成功能创建专用的Personal Access Token
- **最小权限原则**: 只授予必要的API权限
- **定期轮换**: 定期更新访问令牌和Webhook密钥
- **监控连接**: 定期检查实例连接状态
- **多实例管理**: 为不同环境（开发、测试、生产）配置不同的实例

### 2. 项目映射

- **合理映射**: 只映射需要同步的项目
- **字段对齐**: 确保字段映射符合业务需求
- **测试映射**: 在正式使用前测试映射配置
- **定期审查**: 定期审查映射关系是否仍然有效
- **命名规范**: 使用一致的命名规范便于管理

### 3. 同步策略

- **增量优先**: 优先使用增量同步减少系统负载
- **错峰同步**: 在系统负载较低时执行全量同步
- **监控同步**: 密切关注同步状态和错误日志
- **及时处理**: 及时处理同步失败的情况
- **备份策略**: 定期备份同步配置和数据

### 4. 事件处理

- **Webhook配置**: 正确配置GitLab Webhook
- **事件过滤**: 只处理需要的事件类型
- **错误处理**: 及时处理事件处理错误
- **性能监控**: 监控事件处理性能
- **重试机制**: 配置合适的重试策略

### 5. 团队协作

- **权限管理**: 合理分配用户权限和角色
- **培训支持**: 为团队成员提供使用培训
- **文档维护**: 保持文档的及时更新
- **反馈收集**: 收集用户反馈持续改进

## 故障排除

### 常见问题

#### 1. 实例连接失败

**症状**: 测试连接时显示连接失败

**可能原因**:
- URL格式不正确
- 访问令牌无效或过期
- 网络连接问题
- GitLab实例不可访问

**解决方案**:
- 检查URL格式是否正确
- 验证访问令牌是否有效
- 检查网络连接
- 确认GitLab实例状态

#### 2. 同步失败

**症状**: 数据同步过程中出现错误

**可能原因**:
- 权限不足
- 数据格式不兼容
- 网络超时
- GitLab API限制

**解决方案**:
- 检查API权限
- 验证数据格式
- 调整超时设置
- 检查API使用限制

#### 3. Webhook事件未接收

**症状**: GitLab事件未被系统接收

**可能原因**:
- Webhook配置错误
- 网络连接问题
- 签名验证失败
- 事件格式不支持

**解决方案**:
- 检查GitLab Webhook配置
- 验证网络连接
- 检查Webhook密钥
- 确认事件格式

#### 4. 权限错误

**症状**: 操作时提示权限不足

**可能原因**:
- 用户角色权限不足
- 权限配置错误
- 上下文权限限制

**解决方案**:
- 检查用户角色
- 验证权限配置
- 联系管理员调整权限

### 日志查看

系统提供详细的日志信息帮助诊断问题：

1. **应用日志**: 查看系统运行日志
2. **事件日志**: 查看事件处理日志
3. **同步日志**: 查看数据同步日志
4. **错误日志**: 查看错误详情

### 联系支持

如果遇到无法解决的问题，请联系技术支持：

- **技术支持邮箱**: support@example.com
- **文档中心**: https://docs.example.com
- **社区论坛**: https://community.example.com

## 更新和维护

### 定期维护

- **数据清理**: 定期清理过期的同步数据
- **日志轮转**: 定期清理系统日志
- **性能优化**: 根据使用情况优化配置
- **安全更新**: 及时更新安全补丁

### 版本升级

- **备份数据**: 升级前备份重要数据
- **测试环境**: 在测试环境验证升级
- **分步升级**: 分步骤进行升级
- **回滚计划**: 准备回滚方案

## 附录

### A. GitLab Personal Access Token权限

创建Personal Access Token时需要以下权限：

- `read_api`: 读取API数据
- `read_user`: 读取用户信息
- `read_repository`: 读取仓库信息
- `read_registry`: 读取注册表信息

### B. Webhook事件配置

在GitLab中配置Webhook时需要选择以下事件：

- Push events
- Issues events
- Merge request events
- Pipeline events

### C. 系统要求

- **Node.js**: 16.x 或更高版本
- **数据库**: MySQL 8.0 或更高版本
- **内存**: 最少2GB可用内存
- **存储**: 根据数据量确定存储空间

### D. 性能建议

- **实例数量**: 建议不超过10个GitLab实例
- **映射数量**: 建议每个实例不超过100个项目映射
- **同步频率**: 建议增量同步间隔不少于5分钟
- **并发限制**: 建议同时运行的同步任务不超过5个

### E. 配置完成检查清单

完成GitLab集成配置后，请使用以下检查清单验证配置是否正确：

#### GitLab实例配置检查
- [ ] GitLab实例连接测试通过
- [ ] Personal Access Token权限正确
- [ ] Webhook密钥已设置
- [ ] 同步选项已正确配置

#### 项目映射检查
- [ ] 项目映射已创建
- [ ] 字段映射配置正确
- [ ] 同步方向设置符合需求
- [ ] 映射关系测试通过

#### Webhook配置检查
- [ ] GitLab Webhook已配置
- [ ] Webhook URL正确
- [ ] Secret Token匹配
- [ ] 事件类型已选择
- [ ] Webhook测试通过

#### 初始同步检查
- [ ] 全量同步已执行
- [ ] 同步过程无错误
- [ ] 数据同步完整
- [ ] 用户信息已同步

#### 功能验证检查
- [ ] 在GitLab中创建Issue，项目管理工具中可见
- [ ] 在项目管理工具中更新Issue状态，GitLab中同步
- [ ] Merge Request信息正确同步
- [ ] Pipeline状态正确同步
- [ ] 用户权限设置正确

#### 监控和维护检查
- [ ] 事件日志正常记录
- [ ] 同步状态监控正常
- [ ] 错误日志无异常
- [ ] 性能指标在正常范围

如果以上任何一项检查未通过，请参考故障排除部分或联系技术支持。
