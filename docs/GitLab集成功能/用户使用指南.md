# GitLab集成功能用户使用指南

## 概述

GitLab集成功能允许您将项目管理工具与GitLab实例连接，实现项目、问题、合并请求、流水线等数据的自动同步。本指南将帮助您快速上手并充分利用这些功能。

## 功能特性

- **多实例支持**: 支持连接多个GitLab实例（自托管和GitLab.com）
- **实时同步**: 通过Webhook实现实时数据同步
- **项目映射**: 将内部项目与GitLab项目建立映射关系
- **用户同步**: 自动同步GitLab用户信息
- **事件管理**: 完整的事件处理和重试机制
- **权限控制**: 基于角色的细粒度权限管理

## 快速开始

### 1. 访问GitLab集成页面

1. 登录项目管理工具
2. 在左侧导航菜单中点击"GitLab集成"
3. 确保您有相应的权限（系统管理员或项目管理员）

### 2. 添加GitLab实例

1. 在"GitLab实例"标签页中点击"添加GitLab实例"
2. 填写实例信息：
   - **实例名称**: 便于识别的名称
   - **实例URL**: GitLab实例的完整URL
   - **访问令牌**: 具有适当权限的Personal Access Token
   - **Webhook密钥**: 用于验证Webhook事件的密钥
   - **实例类型**: 选择"自托管"或"GitLab.com"
3. 配置同步选项：
   - 同步用户信息
   - 同步问题
   - 同步合并请求
   - 同步流水线
4. 点击"测试连接"验证配置
5. 点击"创建"完成实例添加

### 3. 创建项目映射

1. 切换到"项目映射"标签页
2. 点击"添加映射"
3. 选择要映射的内部项目
4. 选择GitLab实例
5. 选择GitLab项目
6. 配置字段映射和同步选项
7. 点击"创建"完成映射

## 详细功能说明

### GitLab实例管理

#### 创建实例

在添加GitLab实例时，需要提供以下信息：

**基本信息**:
- **实例名称**: 用于标识的友好名称
- **实例URL**: GitLab实例的完整URL（如：https://gitlab.example.com）
- **访问令牌**: 具有API访问权限的Personal Access Token
- **Webhook密钥**: 用于验证Webhook事件的安全密钥
- **实例类型**: 
  - 自托管：您自己部署的GitLab实例
  - GitLab.com：GitLab官方云服务

**同步配置**:
- **同步用户信息**: 自动同步GitLab用户到系统
- **同步问题**: 同步GitLab Issues到内部问题系统
- **同步合并请求**: 同步Merge Requests信息
- **同步流水线**: 同步Pipeline执行状态

**高级配置**:
- **API超时时间**: 与GitLab API通信的超时时间（秒）
- **重试次数**: API调用失败时的重试次数

#### 管理实例

- **查看实例**: 在实例列表中查看所有已配置的实例
- **编辑实例**: 修改实例配置信息
- **测试连接**: 验证实例连接是否正常
- **删除实例**: 移除不再需要的实例

### 项目映射管理

#### 创建映射

项目映射将内部项目与GitLab项目关联，实现数据同步：

1. **选择项目**: 从下拉列表中选择要映射的内部项目
2. **选择实例**: 选择要连接的GitLab实例
3. **选择GitLab项目**: 从实例中获取的项目列表中选择
4. **配置同步**: 设置要同步的数据类型
5. **字段映射**: 配置字段对应关系

#### 字段映射配置

字段映射定义了GitLab数据与内部数据的对应关系：

- **标题字段**: GitLab Issue标题对应的字段
- **描述字段**: GitLab Issue描述对应的字段
- **负责人字段**: GitLab Issue负责人对应的字段
- **标签字段**: GitLab Issue标签对应的字段

#### 管理映射

- **查看映射**: 查看所有项目映射关系
- **编辑映射**: 修改映射配置
- **同步映射**: 手动触发数据同步
- **删除映射**: 移除映射关系

### 同步管理

#### 同步类型

系统支持三种同步类型：

1. **增量同步**: 只同步自上次同步以来的变更
2. **全量同步**: 同步所有数据
3. **补偿同步**: 重新同步失败的数据

#### 执行同步

1. 切换到"同步管理"标签页
2. 选择要同步的GitLab实例
3. 选择同步类型
4. 可选择特定项目进行同步
5. 点击相应的同步按钮启动同步

#### 监控同步状态

- **实时状态**: 查看当前同步任务状态
- **历史记录**: 查看历史同步记录
- **错误日志**: 查看同步过程中的错误信息

### 事件管理

#### 事件类型

系统处理以下类型的GitLab事件：

- **Push事件**: 代码推送事件
- **Merge Request事件**: 合并请求事件
- **Issue事件**: 问题创建、更新、关闭事件
- **Pipeline事件**: 流水线执行事件

#### 事件处理

- **自动处理**: 系统自动处理接收到的Webhook事件
- **重试机制**: 失败的事件会自动重试
- **手动重试**: 可以手动重试失败的事件
- **批量重试**: 可以批量重试多个事件

#### 事件监控

- **事件统计**: 查看事件处理统计信息
- **健康状态**: 监控事件处理系统健康状态
- **错误分析**: 分析事件处理失败的原因

### 权限管理

#### 角色权限

系统定义了以下角色及其权限：

**系统管理员 (system_admin)**:
- 所有GitLab集成功能权限
- 实例管理权限
- 全局同步权限
- 权限配置权限

**项目管理员 (project_admin)**:
- 项目映射管理权限
- 项目级同步权限
- 统计查看权限

**普通用户 (user)**:
- 统计查看权限
- 健康检查权限

#### 权限配置

系统管理员可以配置：

- **启用权限检查**: 是否启用权限验证
- **细粒度权限**: 是否启用细粒度权限控制
- **默认策略**: 未明确权限时的默认策略
- **缓存时间**: 权限信息缓存时间

#### 权限测试

- **权限检查**: 测试特定权限是否有效
- **上下文测试**: 测试特定上下文下的权限
- **用户权限摘要**: 查看用户的完整权限信息

## 最佳实践

### 1. 实例配置

- **使用专用令牌**: 为集成功能创建专用的Personal Access Token
- **最小权限原则**: 只授予必要的API权限
- **定期轮换**: 定期更新访问令牌和Webhook密钥
- **监控连接**: 定期检查实例连接状态

### 2. 项目映射

- **合理映射**: 只映射需要同步的项目
- **字段对齐**: 确保字段映射符合业务需求
- **测试映射**: 在正式使用前测试映射配置
- **定期审查**: 定期审查映射关系是否仍然有效

### 3. 同步策略

- **增量优先**: 优先使用增量同步减少系统负载
- **错峰同步**: 在系统负载较低时执行全量同步
- **监控同步**: 密切关注同步状态和错误日志
- **及时处理**: 及时处理同步失败的情况

### 4. 事件处理

- **Webhook配置**: 正确配置GitLab Webhook
- **事件过滤**: 只处理需要的事件类型
- **错误处理**: 及时处理事件处理错误
- **性能监控**: 监控事件处理性能

## 故障排除

### 常见问题

#### 1. 实例连接失败

**症状**: 测试连接时显示连接失败

**可能原因**:
- URL格式不正确
- 访问令牌无效或过期
- 网络连接问题
- GitLab实例不可访问

**解决方案**:
- 检查URL格式是否正确
- 验证访问令牌是否有效
- 检查网络连接
- 确认GitLab实例状态

#### 2. 同步失败

**症状**: 数据同步过程中出现错误

**可能原因**:
- 权限不足
- 数据格式不兼容
- 网络超时
- GitLab API限制

**解决方案**:
- 检查API权限
- 验证数据格式
- 调整超时设置
- 检查API使用限制

#### 3. Webhook事件未接收

**症状**: GitLab事件未被系统接收

**可能原因**:
- Webhook配置错误
- 网络连接问题
- 签名验证失败
- 事件格式不支持

**解决方案**:
- 检查GitLab Webhook配置
- 验证网络连接
- 检查Webhook密钥
- 确认事件格式

#### 4. 权限错误

**症状**: 操作时提示权限不足

**可能原因**:
- 用户角色权限不足
- 权限配置错误
- 上下文权限限制

**解决方案**:
- 检查用户角色
- 验证权限配置
- 联系管理员调整权限

### 日志查看

系统提供详细的日志信息帮助诊断问题：

1. **应用日志**: 查看系统运行日志
2. **事件日志**: 查看事件处理日志
3. **同步日志**: 查看数据同步日志
4. **错误日志**: 查看错误详情

### 联系支持

如果遇到无法解决的问题，请联系技术支持：

- **技术支持邮箱**: support@example.com
- **文档中心**: https://docs.example.com
- **社区论坛**: https://community.example.com

## 更新和维护

### 定期维护

- **数据清理**: 定期清理过期的同步数据
- **日志轮转**: 定期清理系统日志
- **性能优化**: 根据使用情况优化配置
- **安全更新**: 及时更新安全补丁

### 版本升级

- **备份数据**: 升级前备份重要数据
- **测试环境**: 在测试环境验证升级
- **分步升级**: 分步骤进行升级
- **回滚计划**: 准备回滚方案

## 附录

### A. GitLab Personal Access Token权限

创建Personal Access Token时需要以下权限：

- `read_api`: 读取API数据
- `read_user`: 读取用户信息
- `read_repository`: 读取仓库信息
- `read_registry`: 读取注册表信息

### B. Webhook事件配置

在GitLab中配置Webhook时需要选择以下事件：

- Push events
- Issues events
- Merge request events
- Pipeline events

### C. 系统要求

- **Node.js**: 16.x 或更高版本
- **数据库**: MySQL 8.0 或更高版本
- **内存**: 最少2GB可用内存
- **存储**: 根据数据量确定存储空间

### D. 性能建议

- **实例数量**: 建议不超过10个GitLab实例
- **映射数量**: 建议每个实例不超过100个项目映射
- **同步频率**: 建议增量同步间隔不少于5分钟
- **并发限制**: 建议同时运行的同步任务不超过5个
